
<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatCan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #1f000e, #0c002b, #1d001f, #001f2b);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: #e0e0e0;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        .glassmorphism {
            background: rgba(26, 32, 44, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary {
            @apply bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105;
        }

        .input-field {
            @apply w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 transition-all;
        }

        /* Writing animation */
        .writing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e0e0e0;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .writing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .writing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Mobile bottom navbar */
        .mobile-nav {
            @apply md:hidden fixed bottom-0 left-0 right-0 h-16 glassmorphism flex justify-around items-center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .mobile-nav-item {
            @apply flex flex-col items-center text-gray-400;
        }
        .mobile-nav-item.active {
            @apply text-red-500;
        }
        
        /* Hide chat window on mobile by default */
        @media (max-width: 767px) {
            #chat-window { display: none; }
            #chat-window.active { display: flex; }
            #user-list-container.hidden-mobile { display: none; }
        }

    </style>
</head>
<body class="antialiased">

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md glassmorphism rounded-2xl shadow-lg p-8">
            <h1 class="text-4xl font-bold text-center text-white mb-2">ChatCan</h1>
            <p class="text-center text-gray-400 mb-8">Dostlarınızla əlaqədə qalın</p>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <h2 class="text-2xl font-semibold text-center text-red-500">Giriş</h2>
                <input type="email" id="login-email" class="input-field" placeholder="E-poçt" required>
                <div id="otp-field" class="hidden">
                    <p class="text-sm text-gray-400 mb-2">E-poçtunuza göndərilən 6 rəqəmli kodu daxil edin.</p>
                    <input type="text" id="login-otp" class="input-field" placeholder="OTP Kodu" maxlength="6">
                </div>
                <button type="submit" class="btn-primary w-full">Davam et</button>
                <p class="text-center text-sm text-gray-400">Hesabınız yoxdur? <a href="#" id="show-register" class="font-medium text-red-500 hover:underline">Qeydiyyatdan keçin</a></p>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="hidden space-y-4">
                <h2 class="text-2xl font-semibold text-center text-red-500">Qeydiyyat</h2>
                <input type="text" id="register-name" class="input-field" placeholder="Adınız" required>
                <input type="email" id="register-email" class="input-field" placeholder="E-poçt" required>
                <input type="password" id="register-password" class="input-field" placeholder="Şifrə" required>
                <button type="submit" class="btn-primary w-full">Qeydiyyat</button>
                <p class="text-center text-sm text-gray-400">Artıq hesabınız var? <a href="#" id="show-login" class="font-medium text-red-500 hover:underline">Daxil olun</a></p>
            </form>
            <p id="auth-error" class="text-red-500 text-center mt-4"></p>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-red-500"></div>
    </div>

    <!-- Chat Container -->
    <div id="chat-container" class="hidden h-screen w-full flex">
        <!-- User List (Sidebar for Desktop) -->
        <div id="user-list-container" class="w-full md:w-1/4 h-full glassmorphism flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <div>
                     <h2 id="current-user-name" class="text-xl font-bold"></h2>
                     <p class="text-xs text-gray-400">ID: <span id="current-user-id"></span></p>
                </div>
                <button id="logout-btn" title="Çıxış" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-sign-out-alt fa-lg"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2" id="user-list">
                <!-- User items will be injected here -->
            </div>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="w-full md:w-3/4 h-full flex flex-col bg-gray-900">
            <!-- Chat Header -->
            <div id="chat-header" class="p-4 glassmorphism flex items-center gap-4 hidden">
                 <button id="back-to-users" class="md:hidden text-gray-400 hover:text-white"><i class="fas fa-arrow-left"></i></button>
                <img id="chat-header-avatar" src="https://placehold.co/40x40/313131/FFFFFF?text=C" class="w-10 h-10 rounded-full">
                <div>
                    <h3 id="chat-header-name" class="font-bold"></h3>
                    <div class="flex items-center gap-2">
                        <span id="chat-header-status" class="text-sm text-gray-400"></span>
                        <div id="writing-indicator-header" class="hidden writing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center text-center p-4">
                 <i class="fas fa-comments fa-5x text-gray-700 mb-4"></i>
                <h2 class="text-2xl font-bold">ChatCan'a Xoş Gəlmisiniz!</h2>
                <p class="text-gray-400">Söhbətə başlamaq üçün soldakı siyahıdan bir istifadəçi seçin.</p>
            </div>


            <!-- Messages Container -->
            <div id="messages-container" class="flex-1 p-4 overflow-y-auto hidden">
                <!-- Messages will be injected here -->
            </div>
            
             <!-- Message Input -->
            <div id="message-input-container" class="p-4 glassmorphism hidden">
                <form id="message-form" class="flex items-center gap-2">
                    <input type="text" id="message-input" class="input-field flex-1 bg-gray-900" placeholder="Mesajınızı yazın..." autocomplete="off">
                    <button type="submit" class="btn-primary rounded-full w-12 h-12 flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Mobile Bottom Navbar -->
    <nav class="mobile-nav" id="mobile-navbar">
        <button id="mobile-chats-btn" class="mobile-nav-item active">
            <i class="fas fa-comments fa-lg"></i>
            <span class="text-xs mt-1">Söhbətlər</span>
        </button>
        <button id="mobile-profile-btn" class="mobile-nav-item">
            <i class="fas fa-user fa-lg"></i>
            <span class="text-xs mt-1">Profil</span>
        </button>
    </nav>
    
    <!-- Custom Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="glassmorphism rounded-lg p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-content"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Ləğv et</button>
                <button id="modal-confirm" class="btn-primary">Təsdiq et</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            onSnapshot,
            addDoc,
            query,
            orderBy,
            serverTimestamp,
            updateDoc,
            deleteDoc,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getDatabase,
            ref,
            onValue,
            set,
            onDisconnect, 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Firebase Configuration ---
        // IMPORTANT: Bu konfiqurasiya, Canvas mühitində avtomatik təmin edilir.
        // Tətbiqi başqa yerdə işə salmaq üçün öz Firebase konfiqurasiyanızı daxil etməlisiniz.
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

        const firebaseConfig = {
  apiKey: "AIzaSyCT7Ih36xNcp3rMgFB17OyleTh-kaeBBZk",
  authDomain: "weightoff-b7916.firebaseapp.com",
  databaseURL: "https://weightoff-b7916-default-rtdb.firebaseio.com",
  projectId: "weightoff-b7916",
  storageBucket: "weightoff-b7916.appspot.com", // burada düzəliş et
  messagingSenderId: "623909660439",
  appId: "1:623909660439:web:29d5305a401c84bfd2b952",
  measurementId: "G-006DGJR805"
};
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chatcan-app';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const otpField = document.getElementById('otp-field');
        const logoutBtn = document.getElementById('logout-btn');
        const userList = document.getElementById('user-list');
        const chatWindow = document.getElementById('chat-window');
        const chatHeader = document.getElementById('chat-header');
        const chatHeaderName = document.getElementById('chat-header-name');
        const chatHeaderStatus = document.getElementById('chat-header-status');
        const welcomeScreen = document.getElementById('welcome-screen');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messageInputContainer = document.getElementById('message-input-container');
        const writingIndicatorHeader = document.getElementById('writing-indicator-header');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- Mobile UI Elements ---
        const userListContainer = document.getElementById('user-list-container');
        const backToUsersBtn = document.getElementById('back-to-users');
        const mobileNavbar = document.getElementById('mobile-navbar');
        const mobileChatsBtn = document.getElementById('mobile-chats-btn');
        const mobileProfileBtn = document.getElementById('mobile-profile-btn');
        
        // --- Modal Elements ---
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');

        // --- App State ---
        let currentUser = null;
        let activeChatPartnerId = null;
        let unsubscribeUserList = null;
        let unsubscribeMessages = null;
        let unsubscribeStatus = null;
        let unsubscribeTyping = null;
        let typingTimeout = null;

        // --- Utility Functions ---
        const showLoading = (show) => {
            loadingSpinner.style.display = show ? 'flex' : 'none';
        };

        const showAuthError = (message) => {
            authError.textContent = message;
        };
        
        const showModal = (title, content, onConfirm) => {
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            if (typeof content === 'string') {
                modalContent.textContent = content;
            } else {
                modalContent.appendChild(content);
            }
            
            customModal.style.display = 'flex';

            modalConfirm.onclick = () => {
                onConfirm();
                hideModal();
            };
            modalCancel.onclick = hideModal;
        };

        const hideModal = () => {
            customModal.style.display = 'none';
        };

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            showLoading(true);
            if (user) {
                const userDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/users`, user.uid));
                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, ...userDoc.data() };
                    document.getElementById('current-user-name').textContent = currentUser.name;
                    document.getElementById('current-user-id').textContent = currentUser.uid.substring(0, 8) + '...';
                    authContainer.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    mobileNavbar.style.display = 'flex';
                    setupPresence(user.uid);
                    listenForUsers();
                } else {
                    // This case might happen if user doc creation fails after signup
                    await signOut(auth);
                }
            } else {
                currentUser = null;
                authContainer.style.display = 'flex';
                chatContainer.style.display = 'none';
                mobileNavbar.style.display = 'none';
                if(unsubscribeUserList) unsubscribeUserList();
            }
            showLoading(false);
        });

        const initialAuth = async () => {
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    // For local testing, you might need to sign in differently or rely on cached credentials.
                    console.log("No initial auth token found, anonymous sign-in might be needed for testing.");
                }
            } catch (error) {
                console.error("Initial authentication failed:", error);
                await signInAnonymously(auth); // Fallback for environments without the token
            }
        };

        // --- Event Listeners ---
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            showAuthError('');
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            showAuthError('');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showAuthError('');
            const email = document.getElementById('login-email').value;
            const otp = document.getElementById('login-otp').value;

            if (!otpField.classList.contains('hidden')) {
                // Nodemailer/OTP simulation
                // In a real app, you'd verify the OTP with your backend.
                // Here, we simulate a successful login if the email exists.
                if (otp === "123456") { // Dummy OTP
                    showLoading(true);
                    try {
                        // We can't directly sign in with just email in Firebase, so we'll use a dummy password.
                        // This is a big limitation of frontend-only OTP. A real app uses custom tokens.
                        // For this demo, let's pretend a password exists. The user must register first.
                         const userCredential = await signInWithEmailAndPassword(auth, email, 'password123'); // A user registered with this password
                    } catch (error) {
                         showAuthError("Giriş xətası. Düzgün e-poçt və ya şifrə daxil edin."); // Generic error for simulation
                         console.error("Simulated OTP Login Error:", error);
                    } finally {
                        showLoading(false);
                    }
                } else {
                    showAuthError("Yanlış OTP kodu.");
                }
            } else {
                // First step of login: ask for OTP
                // In a real app, this would trigger an email.
                // Here, we just show the OTP field.
                otpField.classList.remove('hidden');
                alert("Simulyasiya: OTP kodunuz '123456'. Real tətbiqdə bu kod e-poçtunuza göndərilərdi.");
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showAuthError('');
            showLoading(true);
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value; // In a real OTP system, password might not be needed.

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user document in Firestore
                await setDoc(doc(db, `artifacts/${appId}/public/data/users`, user.uid), {
                    name: name,
                    email: email,
                    avatar: `https://placehold.co/40x40/505050/FFFFFF?text=${name.charAt(0).toUpperCase()}`
                });
            } catch (error) {
                console.error("Registration Error:", error);
                showAuthError("Qeydiyyat zamanı xəta baş verdi: " + error.message);
            } finally {
                showLoading(false);
            }
        });

        logoutBtn.addEventListener('click', async () => {
             // Set status to offline before signing out
            if (currentUser) {
                const userStatusRef = ref(rtdb, `/status/${currentUser.uid}`);
                await set(userStatusRef, { isOnline: false, last_changed: serverTimestamp() });
            }
            await signOut(auth);
            resetChatUI();
        });

        // --- Presence (Online/Offline Status) ---
        const setupPresence = (uid) => {
            const userStatusDatabaseRef = ref(rtdb, `/status/${uid}`);
            const userStatusFirestoreRef = doc(db, `artifacts/${appId}/public/data/users`, uid);

            const isOfflineForDatabase = {
                isOnline: false,
                last_changed: Date.now(), // Use client time for onDisconnect
            };
            const isOnlineForDatabase = {
                isOnline: true,
                last_changed: Date.now(),
            };
            
            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    onDisconnect(userStatusDatabaseRef).set(isOfflineForDatabase).then(() => {
                        set(userStatusDatabaseRef, isOnlineForDatabase);
                        updateDoc(userStatusFirestoreRef, { isOnline: true });
                    });
                } else {
                     updateDoc(userStatusFirestoreRef, { isOnline: false });
                }
            });
        };
        
        // --- Chat Logic ---
        const listenForUsers = () => {
            if (unsubscribeUserList) unsubscribeUserList();

            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where("email", "!=", currentUser.email)); // Don't show self

            unsubscribeUserList = onSnapshot(q, (snapshot) => {
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                renderUserList(users);
            });
        };

        const renderUserList = (users) => {
            userList.innerHTML = '';
            if (users.length === 0) {
                userList.innerHTML = '<p class="p-4 text-gray-500">Heç bir istifadəçi tapılmadı.</p>';
                return;
            }
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center p-3 hover:bg-gray-700 cursor-pointer rounded-lg transition-colors';
                userDiv.dataset.uid = user.id;

                const statusIndicator = document.createElement('div');
                statusIndicator.className = 'w-3 h-3 rounded-full mr-3 shrink-0';
                statusIndicator.id = `status-${user.id}`;
                
                userDiv.innerHTML = `
                    <div class="relative">
                        <img src="${user.avatar}" alt="${user.name}" class="w-10 h-10 rounded-full">
                        <div id="status-${user.id}" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-gray-800"></div>
                    </div>
                    <div class="ml-3 flex-1 overflow-hidden">
                        <p class="font-semibold truncate">${user.name}</p>
                        <p class="text-sm text-gray-400 truncate">${user.email}</p>
                    </div>
                `;
                
                userList.appendChild(userDiv);
                
                // Listen for this specific user's status
                const userStatusRef = ref(rtdb, `/status/${user.id}`);
                onValue(userStatusRef, (snap) => {
                    const statusDiv = document.getElementById(`status-${user.id}`);
                    if (statusDiv) {
                        if (snap.exists() && snap.val().isOnline) {
                            statusDiv.className = 'absolute bottom-0 right-0 w-3 h-3 rounded-full bg-green-500 border-2 border-gray-800';
                        } else {
                            statusDiv.className = 'absolute bottom-0 right-0 w-3 h-3 rounded-full bg-gray-500 border-2 border-gray-800';
                        }
                    }
                });

                userDiv.addEventListener('click', () => startChat(user));
            });
        };
        
        const startChat = (partner) => {
            activeChatPartnerId = partner.id;
            
            welcomeScreen.style.display = 'none';
            chatHeader.classList.remove('hidden');
            messagesContainer.classList.remove('hidden');
            messageInputContainer.classList.remove('hidden');
            messagesContainer.style.display = 'block';


            chatHeaderName.textContent = partner.name;
            document.getElementById('chat-header-avatar').src = partner.avatar;
            
            // Mobile view handling
            if (window.innerWidth < 768) {
                userListContainer.classList.add('hidden-mobile');
                chatWindow.classList.add('active');
            }
            
            if (unsubscribeStatus) unsubscribeStatus();
            const partnerStatusRef = ref(rtdb, `/status/${partner.id}`);
            unsubscribeStatus = onValue(partnerStatusRef, (snap) => {
                if (snap.exists() && snap.val().isOnline) {
                    chatHeaderStatus.textContent = "Onlayn";
                    chatHeaderStatus.classList.remove('text-gray-400');
                    chatHeaderStatus.classList.add('text-green-400');
                } else {
                    chatHeaderStatus.textContent = "Oflayn";
                    chatHeaderStatus.classList.remove('text-green-400');
                    chatHeaderStatus.classList.add('text-gray-400');
                }
            });
            
            listenForMessages();
            listenForTyping();
        };

        const listenForMessages = () => {
            if (unsubscribeMessages) unsubscribeMessages();

            const chatId = getChatId();
            const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy('timestamp'));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    renderMessage(doc.id, doc.data());
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        };
        
        const getChatId = () => {
            return [currentUser.uid, activeChatPartnerId].sort().join('_');
        };

        const renderMessage = (id, data) => {
            const isCurrentUser = data.senderId === currentUser.uid;
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex mb-4 ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
            
            const date = data.timestamp?.toDate().toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' }) || '';
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="${isCurrentUser ? 'bg-red-800' : 'bg-gray-700'} rounded-xl p-3"
                         data-msg-id="${id}"
                         data-sender-id="${data.senderId}">
                        <p class="text-white">${data.text} ${data.edited ? '<span class="text-xs text-gray-400 ml-1">(redaktə edilib)</span>' : ''}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 px-2 ${isCurrentUser ? 'text-right' : 'text-left'}">${date}</div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);

            // Add context menu for message actions
            const messageBubble = messageDiv.querySelector('[data-msg-id]');
            messageBubble.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageActions(e, id, data);
            });
        };

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '' || !activeChatPartnerId) return;

            const chatId = getChatId();
            const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatId}/messages`);
            
            try {
                await addDoc(messagesRef, {
                    text: text,
                    senderId: currentUser.uid,
                    receiverId: activeChatPartnerId,
                    timestamp: serverTimestamp(),
                    edited: false
                });
                messageInput.value = '';
                updateTypingStatus(false);
            } catch (error) {
                console.error("Error sending message:", error);
            }
        });
        
        messageInput.addEventListener('input', () => {
            if(typingTimeout) clearTimeout(typingTimeout);
            updateTypingStatus(true);
            typingTimeout = setTimeout(() => {
                updateTypingStatus(false);
            }, 3000);
        });
        
        const updateTypingStatus = async (isTyping) => {
            if (!activeChatPartnerId) return;
            const chatId = getChatId();
            const typingRef = doc(db, `artifacts/${appId}/public/data/chats/${chatId}/typing`, currentUser.uid);
            try {
                await setDoc(typingRef, { isTyping });
            } catch (error) {
                 console.error("Error updating typing status:", error);
            }
        };

        const listenForTyping = () => {
             if (unsubscribeTyping) unsubscribeTyping();
             if (!activeChatPartnerId) return;
             
             const chatId = getChatId();
             const typingRef = doc(db, `artifacts/${appId}/public/data/chats/${chatId}/typing`, activeChatPartnerId);
             
             unsubscribeTyping = onSnapshot(typingRef, (doc) => {
                 if(doc.exists() && doc.data().isTyping) {
                     writingIndicatorHeader.style.display = 'block';
                 } else {
                     writingIndicatorHeader.style.display = 'none';
                 }
             });
        };
        
        const showMessageActions = (event, msgId, msgData) => {
             const contextMenu = document.createElement('div');
             contextMenu.className = 'absolute z-10 bg-gray-900 border border-gray-700 rounded-md shadow-lg py-1';
             contextMenu.style.left = `${event.pageX}px`;
             contextMenu.style.top = `${event.pageY}px`;

            const isCurrentUser = msgData.senderId === currentUser.uid;

            if (isCurrentUser) {
                const editBtn = createContextMenuButton('Redaktə et', 'fa-pencil-alt', () => editMessage(msgId, msgData.text));
                const deleteBtn = createContextMenuButton('Sil', 'fa-trash-alt', () => deleteMessage(msgId));
                contextMenu.appendChild(editBtn);
                contextMenu.appendChild(deleteBtn);
            }

            const forwardBtn = createContextMenuButton('Yönləndir', 'fa-share', () => forwardMessage(msgData));
            contextMenu.appendChild(forwardBtn);
            
            document.body.appendChild(contextMenu);

            const closeMenu = () => {
                if (document.body.contains(contextMenu)) {
                    document.body.removeChild(contextMenu);
                }
                document.removeEventListener('click', closeMenu);
            };

            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        };
        
        const createContextMenuButton = (text, icon, action) => {
            const button = document.createElement('button');
            button.className = 'flex items-center w-full px-4 py-2 text-sm text-gray-300 hover:bg-gray-800';
            button.innerHTML = `<i class="fas ${icon} fa-fw mr-2"></i> ${text}`;
            button.onclick = (e) => {
                e.stopPropagation();
                action();
            };
            return button;
        };
        
        const deleteMessage = async (msgId) => {
            const chatId = getChatId();
            showModal(
                'Mesajı sil',
                'Bu mesajı silmək istədiyinizə əminsiniz?',
                async () => {
                    const msgRef = doc(db, `artifacts/${appId}/public/data/chats/${chatId}/messages`, msgId);
                    await deleteDoc(msgRef);
                }
            );
        };
        
        const editMessage = (msgId, currentText) => {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'input-field w-full';

            showModal(
                'Mesajı redaktə et',
                input,
                async () => {
                    const newText = input.value.trim();
                    if (newText && newText !== currentText) {
                        const chatId = getChatId();
                        const msgRef = doc(db, `artifacts/${appId}/public/data/chats/${chatId}/messages`, msgId);
                        await updateDoc(msgRef, {
                            text: newText,
                            edited: true,
                        });
                    }
                }
            );
             input.focus();
        };

        const forwardMessage = async (msgData) => {
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where("email", "!=", currentUser.email));
            const usersSnapshot = await getDocs(q);

            const userSelectionDiv = document.createElement('div');
            userSelectionDiv.className = 'max-h-60 overflow-y-auto';

            usersSnapshot.forEach(userDoc => {
                const userData = userDoc.data();
                const userItem = document.createElement('div');
                userItem.className = 'p-2 hover:bg-gray-700 rounded cursor-pointer';
                userItem.textContent = userData.name;
                userItem.onclick = () => {
                    userSelectionDiv.querySelectorAll('.bg-red-800').forEach(el => el.classList.remove('bg-red-800'));
                    userItem.classList.add('bg-red-800');
                    userSelectionDiv.dataset.selectedUser = userDoc.id;
                };
                userSelectionDiv.appendChild(userItem);
            });

            showModal(
                'Mesajı yönləndir',
                userSelectionDiv,
                async () => {
                    const targetUserId = userSelectionDiv.dataset.selectedUser;
                    if (targetUserId) {
                        const forwardChatId = [currentUser.uid, targetUserId].sort().join('_');
                        const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${forwardChatId}/messages`);
                        await addDoc(messagesRef, {
                            text: `Yönləndirilmiş mesaj: ${msgData.text}`,
                            senderId: currentUser.uid,
                            receiverId: targetUserId,
                            timestamp: serverTimestamp(),
                            edited: false,
                        });
                    }
                }
            );
        };
        
        const resetChatUI = () => {
            activeChatPartnerId = null;
            welcomeScreen.style.display = 'flex';
            chatHeader.classList.add('hidden');
            messagesContainer.classList.add('hidden');
            messageInputContainer.classList.add('hidden');
            messagesContainer.innerHTML = '';
            
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeStatus) unsubscribeStatus();
            if (unsubscribeTyping) unsubscribeTyping();
        };

        // --- Mobile navigation ---
        backToUsersBtn.addEventListener('click', () => {
            chatWindow.classList.remove('active');
            userListContainer.classList.remove('hidden-mobile');
            resetChatUI();
        });

        mobileChatsBtn.addEventListener('click', () => {
            userListContainer.style.display = 'flex';
            document.getElementById('current-user-name').parentElement.parentElement.style.display = 'none'; // Hide profile header
            mobileChatsBtn.classList.add('active');
            mobileProfileBtn.classList.remove('active');
        });

        mobileProfileBtn.addEventListener('click', () => {
             userListContainer.style.display = 'flex';
             userList.innerHTML = ''; // Clear user list
             document.getElementById('current-user-name').parentElement.parentElement.style.display = 'flex'; // Show profile header
             mobileProfileBtn.classList.add('active');
             mobileChatsBtn.classList.remove('active');
             if (window.innerWidth < 768) {
                chatWindow.classList.remove('active');
                userListContainer.classList.remove('hidden-mobile');
            }
        });


        // --- Initial Load ---
        initialAuth();

    </script>
</body>
</html>